import pandas as pd
import requests

# Step 1: Read from DLT Table (Databricks SQL table)
df = spark.read.table("core_tst_sys9.default.ddl_compare_source_level")

# Step 2: Convert to Pandas for processing
df_pd = df.select("comparison_result", "table_name").dropna().toPandas()

# Step 3: Calculate value counts and percentages
value_counts = df_pd["comparison_result"].value_counts()
percentages = (value_counts / value_counts.sum()) * 100

# Step 4: Create plain-text summary table and progress bar for DDL comparison
ddl_table = "Comparison Result       | Distinct Tables | Count  | Percentage\n"
ddl_table += "------------------------|------------------|--------|-----------\n"
progress_bar_ddl = ""

distinct_tables = df_pd.groupby("comparison_result")["table_name"].nunique()
df_pd["status_group"] = df_pd["comparison_result"].apply(lambda x: "Match" if x.lower() == "match" else "Mismatch")
status_group_counts = df_pd["status_group"].value_counts()
total = status_group_counts.sum()

for status_group, count in status_group_counts.items():
    percent = (count / total) * 100
    icon = "✅" if status_group == "Match" else "❌"
    color = "#28a745" if status_group == "Match" else "#dc3545"
    progress_bar_ddl += f"<div style='background:#e0e0e0;border-radius:5px;width:100%;margin-bottom:5px;'>"
    progress_bar_ddl += f"<div style='width:{percent:.2f}%;background:{color};color:white;padding:2px 5px;border-radius:5px;font-size:12px;'>"
    progress_bar_ddl += f"{icon} {status_group} - {percent:.2f}%" + "</div></div>"

for result, count in value_counts.items():
    percent = percentages[result]
    tables = distinct_tables.get(result, 0)
    ddl_table += f"{result:<24} | {tables:^16} | {count:^6} | {percent:>9.2f}%\n"

# Step 5: Use SQL to get latest validation data
query = """
SELECT
  validation_timestamp,
  table_name,
  src_count,
  tgt_count,
  status,
  comment,
  time_taken_seconds,
  test_case_detail,
  run_id
FROM core_tst_sys9.default.data_migration_validation_results
WHERE run_id = (SELECT MAX(run_id) FROM core_tst_sys9.default.data_migration_validation_results)
"""

latest_pd = spark.sql(query).toPandas()
latest_run_id = latest_pd["run_id"].iloc[0] if not latest_pd.empty else "N/A"
latest_validation_timestamp = latest_pd["validation_timestamp"].iloc[0] if not latest_pd.empty else "N/A"

# Step 6: Calculate status percentages for validation
status_counts = latest_pd['status'].value_counts()
status_percentages = (status_counts / status_counts.sum()) * 100

validation_summary_table = "Status         | Count  | Percentage\n"
validation_summary_table += "---------------|--------|-----------\n"
progress_bar = ""

for status, count in status_counts.items():
    percent = status_percentages[status]
    progress_bar += f"<div style='background:#e0e0e0;border-radius:5px;width:100%;margin-bottom:5px;'>"
    color = "#28a745" if status.lower() == "pass" else "#dc3545"
    icon = "✅" if status.lower() == "pass" else "❌"
    progress_bar += f"<div style='width:{percent:.2f}%;background:{color};color:white;padding:2px 5px;border-radius:5px;font-size:12px;'>"
    progress_bar += f"{icon} {status} - {percent:.2f}%" + "</div></div>"
    validation_summary_table += f"{status:<15} | {count:^6} | {percent:>9.2f}%\n"

# Step 7: Build Teams MessageCard payload
teams_webhook_url = "https://outlook.office.com/webhook/..."  # Replace with your Teams webhook

payload = {
    "@type": "MessageCard",
    "@context": "http://schema.org/extensions",
    "summary": "DLT and Validation Metrics",
    "title": "📊 DLT Table & Data Validation Summary",
    "sections": [
        {
            "text": f"### 🧮 **DDL Comparison Metrics**\n🕒 Validation Timestamp: **{latest_validation_timestamp}**\n🆔 Run ID: **{latest_run_id}**\n\n```\n{ddl_table}```\n\n**Progress Overview:**<br>{progress_bar_ddl}"
        },
        {
            "text": f"### 📋 **Data Validation Status Summary**\n```\n{validation_summary_table}```\n\n**Progress Overview:**<br>{progress_bar}"
        }
    ]
}

# Step 8: Send to Teams
response = requests.post(teams_webhook_url, json=payload)

# Check HTTP response from Teams
print(f"Status Code: {response.status_code}")
print(f"Response Text: {response.text}")

if response.status_code == 200:
    if "message delivery failed" in response.text.lower():
        print("❌ Message delivery failed even though request succeeded.")
    else:
        print("✅ Message sent to Teams!")
else:
    print("❌ Failed to send message.")
