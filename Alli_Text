-- =========================================
-- STEP 1: Filter A and build a clean timestamp
-- =========================================
WITH A_filtered AS (
    SELECT
        mqsQuoteId,
        interactionId,
        product,

        -- make sure we always have a usable timestamp
        COALESCE(
            requestDateTime,
            TO_TIMESTAMP(CONCAT(requestDate, ' ', requestTime), 'yyyy-MM-dd HH:mm:ss')
        ) AS requestDateTime
    FROM core_bld_radar_live.dlt_bronze_recon_athena_source
    WHERE requestDate = '2025-12-05'
      AND product = 'PropositionWolfMotorInsurance'
),

A_window AS (
    SELECT
        mqsQuoteId,
        interactionId,
        product,
        requestDateTime,
        requestDateTime                           AS a_time,
        requestDateTime + INTERVAL 48 HOURS       AS a_time_48h
    FROM A_filtered
)

-- =========================================
-- STEP 2: For each A row, check if a match
--         EXISTS in B (athena) and C (mqs)
-- =========================================
SELECT
    A.mqsQuoteId                             AS athenaSourceMqsQuoteId,
    A.interactionId                          AS athenaSourceInteractionId,
    A.product                                AS athenaSourceProduct,
    A.requestDateTime                        AS athenaSourceRequestDateTime,

    -- true if at least one matching Athena Stream row exists in 48h window
    CASE WHEN EXISTS (
        SELECT 1
        FROM core_bld_radar_live.dlt_bronze_recon_athena_stream B
        WHERE LOWER(TRIM(B.athenaStreamMqsQuoteId))   = LOWER(TRIM(A.mqsQuoteId))
          AND LOWER(TRIM(B.athenaStreamInteractionId))= LOWER(TRIM(A.interactionId))
          AND B.athenaStreamQuoteDateTime BETWEEN A.a_time AND A.a_time_48h
    ) THEN TRUE ELSE FALSE END               AS athenaStreamExists,

    -- true if at least one matching MQS row exists in 48h window
    CASE WHEN EXISTS (
        SELECT 1
        FROM core_bld_radar_live.dlt_bronze_recon_mqs C
        WHERE LOWER(TRIM(C.mQSQuoteId))      = LOWER(TRIM(A.mqsQuoteId))
          AND LOWER(TRIM(C.mQSInteractionId))= LOWER(TRIM(A.interactionId))
          AND C.mQSDateTime BETWEEN A.a_time AND A.a_time_48h
    ) THEN TRUE ELSE FALSE END               AS mQSExists

FROM A_window A;

WITH recon AS (
    -- paste the SELECT above here, without the final semicolon
)
SELECT *
FROM recon
WHERE athenaStreamExists = FALSE
   OR mQSExists = FALSE;

