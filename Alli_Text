WITH ph AS (
    SELECT 
        QUOTE_MQS_QUOTE_LNK_KEY AS QUOTE_KEY,
        TRIM(CAST(PROPOSERPOLICYHOLDER_PRN AS STRING)) AS POLICY_HOLDER_PRN
    FROM core_tst.mqs.athn_mqs.dv_prsnl_quote_plhdr_rqst_mtr_athn_mqs_sat
),

dr AS (
    SELECT
        QUOTE_MQS_QUOTE_LNK_KEY AS QUOTE_KEY,
        TRIM(CAST(DRIVER_PRN AS STRING)) AS DRIVER_PRN
    FROM core_tst.mqs.athn_mqs.dv_prsnl_quote_driver_rqst_mtr_athn_mqs_sat
),

driver_group AS (
    SELECT 
        QUOTE_KEY,
        COLLECT_SET(DRIVER_PRN) AS DRIVER_LIST
    FROM dr
    GROUP BY QUOTE_KEY
)

SELECT 
    ph.QUOTE_KEY,
    ph.POLICY_HOLDER_PRN,
    dg.DRIVER_LIST,
    CASE 
        WHEN dg.DRIVER_LIST IS NULL THEN 'N'
        WHEN ARRAY_CONTAINS(dg.DRIVER_LIST, ph.POLICY_HOLDER_PRN) THEN 'Y'
        ELSE 'N'
    END AS IS_POLICY_HOLDER_IN_DRIVER_LIST
FROM ph
LEFT JOIN driver_group dg
    ON ph.QUOTE_KEY = dg.QUOTE_KEY
ORDER BY QUOTE_KEY;
