WITH bounds AS (
    SELECT date_trunc('day', current_timestamp()) AS day_start
),

latest_interval AS (
    SELECT MAX(e.interval_end) AS max_interval
    FROM core_bld.default.monitoring_ehub_30min_metrics e
    JOIN bounds b
      ON e.interval_end >= b.day_start
),

ehub_filtered AS (
    SELECT *
    FROM core_bld.default.monitoring_ehub_30min_metrics
    WHERE message_type <> 'ALL'
),

bronze_mapped AS (
    SELECT 
        CASE 
            WHEN message_type = 'dlt_quote_request' THEN 'mqs-quote-request'
            WHEN message_type = 'dlt_precomp_response' THEN 'precomp-response'
            WHEN message_type = 'dlt_rating_request' THEN 'rating-request'
            WHEN message_type = 'dlt_rating_response' THEN 'rating-response'
            WHEN message_type = 'dlt_cache_id' THEN 'quote-cache-id'
            WHEN message_type = 'dlt_stop_quote' THEN 'stop-quote'
            WHEN message_type = 'dlt_rating_request_dvla_removed' THEN 'dlt_rating_request_dvla_removed'
            WHEN message_type = 'dlt_raw_enrichments' THEN 'dlt_raw_enrichments'
            ELSE 'others'
        END AS message_type_link,
        interval_end,
        message_count,
        is_sla_flag
    FROM core_bld.default.monitoring_mqs_bronze_30min
    WHERE message_type <> 'ALL'
),

interaction_agg AS (
    SELECT 
        interval_start,
        SUM(total_count) AS total_interaction_count
    FROM core_bld.default.monitoring_mqs_interaction_status
    GROUP BY interval_start
)

SELECT
    e.run_date,
    e.interval_end,
    e.message_type AS message_type_link,

    e.message_count AS ehub_count,
    e.is_sla_breach AS ehub_sla,

    COALESCE(b.message_count,0) AS bronze_count,
    COALESCE(b.is_sla_flag,0)   AS bronze_sla,

    e.message_count - COALESCE(b.message_count,0) AS count_difference,

    CASE
        WHEN e.is_sla_breach = 1 
             AND COALESCE(b.is_sla_flag,0) = 1 THEN 'EHUB & BRONZE'
        WHEN e.is_sla_breach = 1 THEN 'EHUB'
        WHEN COALESCE(b.is_sla_flag,0) = 1 THEN 'BRONZE'
        WHEN COALESCE(i.total_interaction_count,0) = 0 THEN 'INTERACTION'
    END AS breach_source

FROM ehub_filtered e

LEFT JOIN bronze_mapped b
    ON e.message_type = b.message_type_link
   AND e.interval_end = b.interval_end

LEFT JOIN interaction_agg i
    ON e.interval_end = i.interval_start

JOIN latest_interval l
    ON e.interval_end = l.max_interval

WHERE (
       e.is_sla_breach = 1
    OR COALESCE(b.is_sla_flag,0) = 1
    OR COALESCE(i.total_interaction_count,0) = 0
)
