WITH parsed AS (
  SELECT
    from_json(
      to_json(payload),
      'STRUCT<
        MQSQuoteId: STRING,
        rawEnrichments: ARRAY<
          STRUCT<
            compression: STRING,
            data: STRING,
            provider: STRING
          >
        >
      >'
    ) AS p
  FROM core_rl_test.flow.ehubstream
),
filtered AS (
  SELECT
    p.MQSQuoteId,
    r.provider,
    r.data
  FROM parsed
  LATERAL VIEW explode(p.rawEnrichments) r
  WHERE p.MQSQuoteId = 'MQS-34354'
    AND r.provider = 'experian'
    AND r.compression = 'snappy'
)
SELECT
  MQSQuoteId,
  provider,
  cast(snappy_uncompress(unbase64(data)) AS STRING) AS decompressed_payload
FROM filtered;
