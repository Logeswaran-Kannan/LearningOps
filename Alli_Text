Below is Databricks-ready Python code to handle **arrays of rawEnrichments**, decompress **each snappy item**, and flatten the output.

---

# âœ… Full Script â€” Handle ARRAY(rawEnrichments) + Snappy decode

```python
from pyspark.sql import functions as F
from pyspark.sql.types import StringType
import snappy
import base64

# UDF: Detect base64 vs binary and decompress
@F.udf(StringType())
def decompress_snappy(data):
    if data is None:
        return None
    try:
        # RAW data may be base64 string â†’ decode first
        try:
            raw = base64.b64decode(data)
        except:
            raw = data
        return snappy.uncompress(raw).decode("utf-8")
    except Exception:
        return None

# Load table
source_df = spark.table("core_tst.mqs_athn_mtr.dlt_raw_enrichments")

# Explode array of rawEnrichments
exploded = source_df.select(
    "MQSQuoteId",
    F.explode("Payload.rawEnrichments").alias("enrich")
)

# Extract fields
with_meta = exploded.select(
    "MQSQuoteId",
    F.col("enrich.compression").alias("compression"),
    F.col("enrich.data").alias("compressed_data"),
    F.col("enrich.dataset").alias("dataset"),
    F.col("enrich.outputformat").alias("outputformat"),
    F.col("enrich.outputschema").alias("outputschema"),
    F.col("enrich.provider").alias("provider"),
    F.col("enrich.vehiclePRN").alias("vehiclePRN")
)

# Decompress snappy data
with_decompressed = with_meta.withColumn(
    "decompressed_json", decompress_snappy(F.col("compressed_data"))
)

# Optional: parse JSON if dataset output is JSON
parsed = with_decompressed.withColumn(
    "json_struct", F.from_json("decompressed_json", "MAP<STRING,STRING>")
)

# Final
final_df = parsed.select(
    "MQSQuoteId",
    "dataset",
    "provider",
    "vehiclePRN",
    "decompressed_json",
    "json_struct.*"
)

final_df.display()
```

---

## ðŸ§¾ What this solves

* Your column **Payload.rawEnrichments** is an **array** â†’ handled via `explode()`.
* Some items are **compression = none** â†’ handled.
* Some items have **snappy** compressed base64 â†’ decoded + decompressed.
* Others include XML, JSON, and output schemas.

---

If you want:
âœ” Fully flatten JSON inside each data blob
âœ” Write decompressed results to a Delta table
âœ” Produce schema automatically from samples

Send me **1â€’2 decompressed JSON examples** and Iâ€™ll generate full flattening code.
