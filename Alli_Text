WITH src AS (
  SELECT
    to_timestamp(get_json_object(payload, '$.timestamp')) AS event_ts,
    get_json_object(payload, '$.interaction.status')     AS status,
    get_json_object(payload, '$.interaction.mqsQuoteId') AS mqs_quote_id,
    get_json_object(payload, '$.interaction.id')         AS interaction_id
  FROM core.flow.ehubstream
  WHERE HubQueuedDatestamp = DATE '2026-02-06'
),

valid_quotes AS (
  SELECT DISTINCT
    headers['externalID'] AS interaction_id
  FROM core.mqs_athn_mtr.ehubstream
  WHERE cast(enqueuedTime AS DATE) = DATE '2026-02-06'
),

bucketed AS (
  SELECT
    date(event_ts) AS run_date,
    date_format(
      date_trunc('day', event_ts)
      + INTERVAL 1 SECOND *
        (CAST(
           (unix_timestamp(event_ts)
            - unix_timestamp(date_trunc('day', event_ts))) / 1800
         AS INT) * 1800),
      'HH:mm'
    ) AS time_slice,
    status,
    mqs_quote_id
  FROM src s
  INNER JOIN valid_quotes v
    ON s.interaction_id = v.interaction_id
)

SELECT
  run_date,
  time_slice,
  status,
  COUNT(mqs_quote_id) AS mqs_quote_id
FROM bucketed
GROUP BY
  run_date,
  time_slice,
  status
ORDER BY
  run_date,
  time_slice,
  status;
