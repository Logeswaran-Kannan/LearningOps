WITH latest_interval AS (
    SELECT MAX(interval_end) AS max_interval
    FROM core_bld.default.monitoring_ehub_30min_metrics
)

SELECT
    a.run_date       AS ehub_rundate,
    a.interval_end   AS interval_end,
    a.message_type,
    a.message_count  AS ehub_message_count,
    b.message_count  AS bronze_message_count,
    a.is_sla_breach  AS ehub_is_sla_breach,
    b.is_sla_flag    AS bronze_is_sla_breach,
    a.message_count - b.message_count AS count_difference
FROM core_bld.default.monitoring_ehub_30min_metrics a
LEFT JOIN core_bld.default.monitoring_mqs_bronze_30min b
    ON a.message_type = b.message_type_link
   AND a.interval_end = b.interval_end
JOIN latest_interval l
    ON a.interval_end = l.max_interval
WHERE a.message_type <> 'ALL'
  AND (
        a.is_sla_breach = 1
     OR b.is_sla_flag = 1
      )
