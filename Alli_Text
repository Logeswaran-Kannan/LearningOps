WITH A AS (
    SELECT
        mqsQuoteId,
        interactionId,
        product,
        requestDateTime,
        requestDateTime AS a_time,
        requestDateTime + INTERVAL 48 HOURS AS a_time_48h
    FROM core_bld_radar_live.dlt_bronze_recon_athena_source
    WHERE requestDate = '2025-12-05'
      AND product = 'PropositionWolfMotorInsurance'
),

MQS AS (
    SELECT
        LOWER(TRIM(mqsQuoteId)) AS mqsQuoteId_norm,
        LOWER(TRIM(mQSInteractionId)) AS interaction_norm,
        -- FIX: correct timestamp construction
        TO_TIMESTAMP(CONCAT(mQSDate, ' ', mQSTime), 'yyyy-MM-dd HH:mm:ss') AS mqs_ts
    FROM core_bld_radar_live.dlt_bronze_recon_mqs
),

ATHENA AS (
    SELECT
        LOWER(TRIM(athenaStreamMqsQuoteId)) AS mqsQuoteId_norm,
        LOWER(TRIM(athenaStreamInteractionId)) AS interaction_norm,
        athenaStreamQuoteDateTime AS athena_ts
    FROM core_bld_radar_live.dlt_bronze_recon_athena_stream
)

SELECT
    A.mqsQuoteId,
    A.interactionId,
    A.product,
    A.requestDateTime,

    -- ATHENA EXISTS
    CASE WHEN EXISTS (
        SELECT 1 FROM ATHENA B
        WHERE LOWER(TRIM(A.mqsQuoteId)) = B.mqsQuoteId_norm
          AND LOWER(TRIM(A.interactionId)) = B.interaction_norm
          AND B.athena_ts BETWEEN A.a_time AND A.a_time_48h
    ) THEN TRUE ELSE FALSE END AS athenaStreamExists,

    -- MQS EXISTS (FIXED LOGIC)
    CASE WHEN EXISTS (
        SELECT 1 FROM MQS C
        WHERE LOWER(TRIM(A.mqsQuoteId)) = C.mqsQuoteId_norm
          AND LOWER(TRIM(A.interactionId)) = C.interaction_norm
          AND C.mqs_ts BETWEEN A.a_time AND A.a_time_48h
    ) THEN TRUE ELSE FALSE END AS mQSExists

FROM A;
