CREATE MATERIALIZED VIEW IF NOT EXISTS core_bld.default.monitoring_mqs_interaction_sta
AS
WITH flow_base AS (
    SELECT
        to_date(get_json_object(payload, '$.timestamp'))              AS run_date,
        timestamp(get_json_object(payload, '$.timestamp'))            AS event_ts,
        get_json_object(payload, '$.interaction.status')              AS status,
        get_json_object(payload, '$.interaction.mqsQuoteId')           AS mqs_quote_id,
        get_json_object(payload, '$.interaction.id')                  AS interaction_id
    FROM core.flow.ehubstream
    WHERE eHubQueuedDatestamp = current_date()
),

mtr_keys AS (
    SELECT DISTINCT
        headers['mqsQuoteId'] AS mqs_quote_id,
        headers['externalId'] AS interaction_id
    FROM core.mqs_atnh_mtr.ehubstream
    WHERE cast(enqueuedTime AS date) = current_date()
),

joined_data AS (
    SELECT
        f.run_date,
        -- 30-min bucket start
        from_unixtime(
            floor(unix_timestamp(f.event_ts) / 1800) * 1800
        ) AS interval_start,
        f.status,
        f.mqs_quote_id
    FROM flow_base f
    JOIN mtr_keys m
      ON f.mqs_quote_id   = m.mqs_quote_id
     AND f.interaction_id = m.interaction_id
)

SELECT
    run_date,
    interval_start,
    status,
    COUNT(mqs_quote_id) AS total_count,
    CASE
        WHEN COUNT(mqs_quote_id) < 3 THEN 1
        ELSE 0
    END AS is_sla_breach
FROM joined_data
GROUP BY
    run_date,
    interval_start,
    status;
