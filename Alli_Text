# ============================================================
# FULL SCRIPT — DECOMPRESS SNAPPY + PARSE + FLATTEN PAYLOAD
# ============================================================

from pyspark.sql import functions as F
from pyspark.sql.types import StringType, MapType
import base64
import snappy

# ------------------------------------------------------------
# UDF: Base64 decode + Snappy decompress
# ------------------------------------------------------------
def decompress_snappy(b64):
    if b64 is None:
        return None
    try:
        decoded = base64.b64decode(b64)          # base64 → bytes
        uncompressed = snappy.decompress(decoded) # snappy → raw JSON bytes
        return uncompressed.decode("utf-8")       # UTF-8 → JSON string
    except Exception as e:
        return f"DECOMPRESSION ERROR: {str(e)}"

decompress_udf = F.udf(decompress_snappy, StringType())


# ------------------------------------------------------------
# READ YOUR TABLE
# ------------------------------------------------------------
table_name = "core_tst.mqs_athn_mtr.dlt_raw_enrichments"
df = spark.table(table_name)

# ------------------------------------------------------------
# Extract the compressed string inside Payload.rawEnrichment.data
# ------------------------------------------------------------
df_extracted = (
    df.withColumn("snappy_base64", F.col("Payload.rawEnrichment.data"))
      .withColumn("decompressed_json", decompress_udf("snappy_base64"))
)

# ------------------------------------------------------------
# SHOW RAW DECOMPRESSED JSON
# ------------------------------------------------------------
df_extracted.select(
    "TimeEnqueued",
    "eHubQueuedDatestamp",
    "decompressed_json"
).show(truncate=False)


# ------------------------------------------------------------
# PARSE JSON TO STRUCT (DYNAMIC — NO SCHEMA NEEDED)
# ------------------------------------------------------------
df_parsed = df_extracted.withColumn(
    "json_struct",
    F.from_json("decompressed_json", MapType(StringType(), StringType()))
)

# ------------------------------------------------------------
# FLATTEN JSON INTO COLUMNS
# ------------------------------------------------------------
df_flat = df_parsed.select(
    "TimeEnqueued",
    "eHubQueuedDatestamp",
    "json_struct.*"
)

df_flat.show(truncate=False)

# ------------------------------------------------------------
# DONE
# ------------------------------------------------------------
