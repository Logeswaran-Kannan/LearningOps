from pyspark.sql import functions as F

spark.sql("""
CREATE TABLE IF NOT EXISTS core_bld.default.monitoring_ehub_30min_metrics (
  interval_start TIMESTAMP,
  interval_end   TIMESTAMP,
  message_type   STRING,
  message_count  BIGINT,
  interval_time  STRING,
  run_date       DATE,
  is_sla_breach  INT
)
USING DELTA
PARTITIONED BY (run_date)
""")

run_ts = F.current_timestamp()
run_date = F.current_date()

day_start = F.date_trunc("day", run_ts)

interval_index = (
    (F.unix_timestamp(run_ts) - F.unix_timestamp(day_start)) / 1800
).cast("int")

interval_start = day_start + F.expr("INTERVAL 1 SECOND") * (interval_index * 1800)
interval_end = interval_start + F.expr("INTERVAL 30 MINUTES")

interval_df = (
    spark.range(1)
    .select(
        interval_start.alias("interval_start"),
        interval_end.alias("interval_end")
    )
    .withColumn(
        "interval_time",
        F.date_format(interval_start, "HH:mm")
    )
)

src_df = (
    spark.table("mqs_athn_mtr.ehubstream")
    .filter(
        (F.col("TimeEnqueued") >= interval_start) &
        (F.col("TimeEnqueued") < interval_end)
    )
    .select(
        F.col("headers.messageType").alias("message_type")
    )
)

agg_by_type_df = (
    src_df
    .groupBy("message_type")
    .agg(F.count("*").alias("message_count"))
)

agg_all_df = (
    src_df
    .agg(F.count("*").alias("message_count"))
    .withColumn("message_type", F.lit("ALL"))
)

agg_df = agg_by_type_df.unionByName(agg_all_df)

final_df = (
    interval_df
    .crossJoin(agg_df)
    .withColumn("run_date", run_date)
    .withColumn(
        "is_sla_breach",
        F.when(F.col("message_count") == 0, F.lit(1)).otherwise(F.lit(0))
    )
)

(
    final_df
    .select(
        "interval_start",
        "interval_end",
        "message_type",
        "message_count",
        "interval_time",
        "run_date",
        "is_sla_breach"
    )
    .write
    .format("delta")
    .mode("append")
    .saveAsTable("core_bld.default.monitoring_ehub_30min_metrics")
)

spark.sql("""
DELETE FROM core_bld.default.monitoring_ehub_30min_metrics
WHERE run_date < current_date() - INTERVAL 2 DAYS
""")
