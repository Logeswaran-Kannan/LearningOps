WITH ph AS (
    SELECT 
        QUOTE_MQS_QUOTE_LNK_KEY AS QUOTE_KEY,
        TRIM(CAST(PROPOSERPOLICYHOLDER_PRN AS STRING)) AS POLICY_HOLDER_PRN
    FROM core_tst.mqs.athn_mqs.dv_prsnl_quote_plhdr_rqst_mtr_athn_mqs_sat
),

dr AS (
    SELECT
        QUOTE_MQS_QUOTE_LNK_KEY AS QUOTE_KEY,
        TRIM(CAST(DRIVER_PRN AS STRING)) AS DRIVER_PRN
    FROM core_tst.mqs.athn_mqs.dv_prsnl_quote_driver_rqst_mtr_athn_mqs_sat
),

driver_group AS (
    SELECT 
        QUOTE_KEY,
        COLLECT_SET(DRIVER_PRN) AS DRIVER_LIST
    FROM dr
    GROUP BY QUOTE_KEY
),

veh_driver_use AS (
    SELECT
        TRIM(CAST(DRIVER_DRIVERPRN AS STRING)) AS DRIVER_PRN,
        DRIVESVEHICLE_DRIVINGFREQUENCY
    FROM core_tst.mqs.athn_mqs.dv_quote_veh_driver_use_rqst_mtr_athn_mqs_sat
),

match_check AS (
    SELECT
        ph.QUOTE_KEY,
        ph.POLICY_HOLDER_PRN,
        dg.DRIVER_LIST,

        -- Array of matching drivers
        FILTER(dg.DRIVER_LIST, d -> d = ph.POLICY_HOLDER_PRN) AS MATCHING_DRIVERS

    FROM ph
    LEFT JOIN driver_group dg
        ON ph.QUOTE_KEY = dg.QUOTE_KEY
)

SELECT
    mc.QUOTE_KEY,
    mc.POLICY_HOLDER_PRN,
    mc.DRIVER_LIST,

    CASE 
        WHEN mc.DRIVER_LIST IS NULL THEN 'N'
        WHEN SIZE(mc.MATCHING_DRIVERS) > 0 THEN 'Y'
        ELSE 'N'
    END AS IS_POLICY_HOLDER_IN_DRIVER_LIST,

    -- Extract which driver matched
    CASE
        WHEN SIZE(mc.MATCHING_DRIVERS) > 0 THEN mc.MATCHING_DRIVERS[0]
        ELSE NULL
    END AS DRIVER_IN_LIST,

    -- Driving frequency for that driver
    vdu.DRIVESVEHICLE_DRIVINGFREQUENCY AS DRIVING_FREQUENCY

FROM match_check mc
LEFT JOIN veh_driver_use vdu
    ON mc.MATCHING_DRIVERS[0] = vdu.DRIVER_PRN
ORDER BY mc.QUOTE_KEY;
