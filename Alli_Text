WITH ph AS (
    SELECT 
        QUOTE_MQS_QUOTE_LNK_KEY AS QUOTE_KEY,
        TRIM(CAST(PROPOSERPOLICYHOLDER_PRN AS STRING)) AS POLICY_HOLDER_PRN
    FROM core_tst.mqs.athn_mqs.dv_prsnl_quote_plhdr_rqst_mtr_athn_mqs_sat
),

dr AS (
    SELECT
        QUOTE_MQS_QUOTE_LNK_KEY AS QUOTE_KEY,
        TRIM(CAST(DRIVER_PRN AS STRING)) AS DRIVER_PRN
    FROM core_tst.mqs.athn_mqs.dv_prsnl_quote_driver_rqst_mtr_athn_mqs_sat
),

driver_group AS (
    SELECT 
        QUOTE_KEY,
        COLLECT_SET(DRIVER_PRN) AS DRIVER_LIST
    FROM dr
    GROUP BY QUOTE_KEY
),

match_check AS (
    SELECT
        ph.QUOTE_KEY,
        ph.POLICY_HOLDER_PRN,
        dg.DRIVER_LIST,

        -- Identify which driver matches (if any)
        FILTER(dg.DRIVER_LIST, d -> d = ph.POLICY_HOLDER_PRN) AS MATCHING_DRIVERS

    FROM ph
    LEFT JOIN driver_group dg
        ON ph.QUOTE_KEY = dg.QUOTE_KEY
)

SELECT
    QUOTE_KEY,
    POLICY_HOLDER_PRN,
    DRIVER_LIST,

    CASE 
        WHEN DRIVER_LIST IS NULL THEN 'N'
        WHEN SIZE(MATCHING_DRIVERS) > 0 THEN 'Y'
        ELSE 'N'
    END AS IS_POLICY_HOLDER_IN_DRIVER_LIST,

    -- New column showing exactly which driver matched
    CASE
        WHEN SIZE(MATCHING_DRIVERS) > 0 THEN MATCHING_DRIVERS[0]
        ELSE NULL
    END AS DRIVER_IN_LIST

FROM match_check
ORDER BY QUOTE_KEY;
