WITH latest_interval AS (
    SELECT MAX(interval_end) AS max_interval
    FROM core_bld.default.monitoring_ehub_30min_metrics
)

SELECT
    a.run_date        AS ehub_rundate,
    a.interval_end    AS interval_end,
    a.message_type,
    a.message_count   AS ehub_message_count,
    b.message_count   AS bronze_message_count,
    a.is_sla_breach   AS ehub_is_sla_breach,
    COALESCE(b.is_sla_flag, 0) AS bronze_is_sla_breach,
    a.message_count - COALESCE(b.message_count, 0) AS count_difference,
    CASE 
        WHEN a.is_sla_breach = 1 AND COALESCE(b.is_sla_flag,0) = 1 
            THEN 'EHUB & BRONZE'
        WHEN a.is_sla_breach = 1 
            THEN 'EHUB ONLY'
        WHEN COALESCE(b.is_sla_flag,0) = 1 
            THEN 'BRONZE ONLY'
    END AS breach_source
FROM core_bld.default.monitoring_ehub_30min_metrics a
LEFT JOIN (
    SELECT 
        CASE 
            WHEN message_type = 'dlt_quote_request' THEN 'mqs-quote-request'
            WHEN message_type = 'dlt_precomp_response' THEN 'precomp-response'
            WHEN message_type = 'dlt_rating_request' THEN 'rating-request'
            WHEN message_type = 'dlt_rating_response' THEN 'rating-response'
            WHEN message_type = 'dlt_cache_id' THEN 'quote-cache-id'
            WHEN message_type = 'dlt_stop_quote' THEN 'stop-quote'
            WHEN message_type = 'dlt_rating_request_dvla_removed' THEN 'dlt_rating_request_dvla_removed'
            WHEN message_type = 'dlt_raw_enrichments' THEN 'dlt_raw_enrichments'
            ELSE 'others'
        END AS message_type_link,
        interval_end,
        message_count,
        is_sla_flag
    FROM core_bld.default.monitoring_mqs_bronze_30min
) b
    ON a.message_type = b.message_type_link
   AND a.interval_end = b.interval_end
JOIN latest_interval l
    ON a.interval_end = l.max_interval
WHERE a.message_type <> 'ALL'
AND (
       a.is_sla_breach = 1
    OR COALESCE(b.is_sla_flag,0) = 1
)
