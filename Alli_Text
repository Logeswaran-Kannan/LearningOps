WITH bounds AS (
  SELECT
    date_trunc('day', current_timestamp()) AS day_start,
    current_timestamp()                   AS now_ts
),

latest_interval AS (
  SELECT MAX(e.interval_end) AS max_interval
  FROM core_bld.default.monitoring_ehub_30min_metrics e
  CROSS JOIN bounds b
  WHERE e.interval_end >= b.day_start
    AND e.interval_end <= b.now_ts
),

ehub_latest AS (
  SELECT
    e.run_date,
    e.interval_end,
    e.message_type AS message_type_link,
    e.message_count AS ehub_count,
    e.is_sla_breach AS ehub_sla
  FROM core_bld.default.monitoring_ehub_30min_metrics e
  JOIN latest_interval l
    ON e.interval_end = l.max_interval
  WHERE e.message_type <> 'ALL'
),

bronze_latest AS (
  SELECT
    CASE
      WHEN message_type = 'dlt_quote_request' THEN 'mqs-quote-request'
      WHEN message_type = 'dlt_precomp_response' THEN 'precomp-response'
      WHEN message_type = 'dlt_rating_request' THEN 'rating-request'
      WHEN message_type = 'dlt_rating_response' THEN 'rating-response'
      WHEN message_type = 'dlt_cache_id' THEN 'quote-cache-id'
      WHEN message_type = 'dlt_stop_quote' THEN 'stop-quote'
      WHEN message_type = 'dlt_rating_request_dvla_removed' THEN 'dlt_rating_request_dvla_removed'
      WHEN message_type = 'dlt_raw_enrichments' THEN 'dlt_raw_enrichments'
      ELSE 'others'
    END AS message_type_link,
    interval_end,
    message_count,
    is_sla_flag
  FROM core_bld.default.monitoring_mqs_bronze_30min b
  JOIN latest_interval l
    ON b.interval_end = l.max_interval
),

interaction_latest AS (
  -- Interaction table is interval-level (not message_type level)
  -- Breach rule: SUM(total_count) = 0 for the latest interval
  SELECT
    i.interval_start,
    SUM(COALESCE(i.total_count,0)) AS interaction_total_count
  FROM core_bld.default.monitoring_mqs_interaction_status i
  JOIN latest_interval l
    ON i.interval_start = l.max_interval
  GROUP BY i.interval_start
),

breaches AS (
  -- EHUB/Bronze breaches at message_type_link level
  SELECT
    e.interval_end,
    e.message_type_link,
    CASE WHEN e.ehub_sla = 1 THEN 1 ELSE 0 END AS ehub_breach,
    CASE WHEN COALESCE(b.is_sla_flag,0) = 1 THEN 1 ELSE 0 END AS bronze_breach,
    0 AS interaction_breach
  FROM ehub_latest e
  LEFT JOIN bronze_latest b
    ON e.message_type_link = b.message_type_link
   AND e.interval_end      = b.interval_end
  WHERE e.ehub_sla = 1
     OR COALESCE(b.is_sla_flag,0) = 1

  UNION ALL

  -- Interaction breach as a single row (interval-level)
  SELECT
    l.max_interval AS interval_end,
    'INTERACTION_TOTAL' AS message_type_link,
    0 AS ehub_breach,
    0 AS bronze_breach,
    CASE WHEN COALESCE(x.interaction_total_count,0) = 0 THEN 1 ELSE 0 END AS interaction_breach
  FROM latest_interval l
  LEFT JOIN interaction_latest x
    ON x.interval_start = l.max_interval
  WHERE COALESCE(x.interaction_total_count,0) = 0
)

SELECT COUNT(*) AS breach_count
FROM breaches;
