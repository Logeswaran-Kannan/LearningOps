import requests
import json
import time

# Azure Databricks cluster configuration
cluster_url = "https://<databricks-instance>.azuredatabricks.net"
token = "<databricks-access-token>"
repo_path = "/your-repo-path/sample_file.py"

# API endpoint for Databricks runs
api_endpoint = f"{cluster_url}/api/2.0/jobs/runs/submit"

# Prepare the request headers with the authentication token
headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

# Prepare the request body with the code to execute
data = {
    "run_name": "Databricks Run",
    "existing_cluster_id": "<cluster-id>",  # Enter your cluster ID here
    "notebook_task": {
        "notebook_path": repo_path
    }
}

# Send the request to Databricks to execute the code
response = requests.post(api_endpoint, headers=headers, data=json.dumps(data))

# Check if the request was successful
if response.status_code == 200:
    run_id = response.json()["run_id"]
    print(f"Run submitted successfully. Run ID: {run_id}")
else:
    print("Error submitting run:", response.text)
    exit()

# Check the run status periodically until it is completed
run_status_endpoint = f"{cluster_url}/api/2.0/jobs/runs/get?run_id={run_id}"
status = None

while status != "TERMINATED":
    time.sleep(5)  # Wait for 5 seconds before checking the status again
    response = requests.get(run_status_endpoint, headers=headers)

    if response.status_code == 200:
        status = response.json()["state"]["life_cycle_state"]
        print(f"Current status: {status}")
    else:
        print("Error retrieving run status:", response.text)
        break

# Retrieve the final status and result
response = requests.get(run_status_endpoint, headers=headers)

if response.status_code == 200:
    status = response.json()["state"]["result_state"]
    result = response.json()["state"]["state_message"]
    print(f"Run completed with status: {status}")
    print(f"Result: {result}")
else:
    print("Error retrieving final run status:", response.text)
