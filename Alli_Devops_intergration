# Final patch to mark all results completed with outcome
final_patch_payload = []
for result in results:
    point_id = result.get("testPoint", {}).get("id")
    result_id = result.get("id")
    if point_id and result_id and point_id in point_id_map:
        info = point_id_map[point_id]
        outcome = "Passed" if info['status'] == "pass" else "Failed"
        final_patch_payload.append({
            "id": result_id,
            "outcome": outcome,
            "state": "Completed"
        })
final_patch_url = f"{devops_organization}/{project}/_apis/test/runs/{run_id}/results?api-version=7.1"
final_patch_response = requests.patch(final_patch_url, headers={**headers, 'Content-Type': 'application/json'}, json=final_patch_payload)
final_patch_response.raise_for_status()
print(f"✅ All test results marked completed successfully.")
print(f"✅ All test results marked completed successfully.")

# Complete run
complete_run_url = f"{devops_organization}/{project}/_apis/test/runs/{run_id}?api-version=7.1"
complete_payload = {"state": "Completed"}
requests.patch(complete_run_url, headers={**headers, 'Content-Type': 'application/json'}, json=complete_payload)

print("✅ Test case table checked/created and test case sync completed.")
