import requests
from requests.auth import HTTPBasicAuth

# Config
organization = "your-org"
project = "your-project"
pat = "your-personal-access-token"
assigned_to = "adm.sug.na"

# Auth and headers
auth = HTTPBasicAuth("", pat)
headers = {"Content-Type": "application/json"}

# Step 1: Query work items assigned to a specific user
wiql_query = {
    "query": f"SELECT [System.Id] FROM WorkItems WHERE [System.AssignedTo] CONTAINS '{assigned_to}' AND [System.TeamProject] = '{project}'"
}
query_url = f"https://dev.azure.com/{organization}/{project}/_apis/wit/wiql?api-version=7.1-preview.2"
response = requests.post(query_url, headers=headers, auth=auth, json=wiql_query)

deleted_items = []

if response.status_code == 200:
    work_items = response.json().get("workItems", [])
    print(f"Found {len(work_items)} work items assigned to {assigned_to}.")

    for item in work_items:
        wid = item["id"]
        
        # Step 2: Validate if the work item exists
        validate_url = f"https://dev.azure.com/{organization}/_apis/wit/workitems/{wid}?api-version=7.1-preview.2"
        validate_response = requests.get(validate_url, headers=headers, auth=auth)
        
        if validate_response.status_code == 200:
            # Step 3: Delete work item (soft delete to Recycle Bin)
            delete_url = f"https://dev.azure.com/{organization}/_apis/wit/workitems/{wid}?api-version=7.1-preview.2"
            del_response = requests.delete(delete_url, headers=headers, auth=auth)
            
            if del_response.status_code in [200, 204]:
                print(f"✅ Successfully deleted (soft) Work Item ID: {wid}")
                deleted_items.append(wid)
            else:
                print(f"⚠️ Failed to delete Work Item ID: {wid} - Status: {del_response.status_code}")
                print(del_response.text)
        else:
            print(f"❌ Work Item ID {wid} not found or inaccessible. Skipping.")

else:
    print(f"❌ Failed to query work items. Status: {response.status_code}")
    print(response.text)

# Final summary
print("\n✅ Deleted Work Item IDs:", deleted_items)
