import requests
from requests.auth import HTTPBasicAuth

# Set your variables
organization = "your-org"
project = "your-project"
pat = "your-personal-access-token"
exclude_ids = [12330, 11]

# Auth and headers
auth = HTTPBasicAuth("", pat)
headers = {
    "Content-Type": "application/json"
}

# Step 1: Get all test plans
list_url = f"https://dev.azure.com/{organization}/{project}/_apis/test/plans?api-version=7.1-preview.2"
response = requests.get(list_url, headers=headers, auth=auth)

if response.status_code == 200:
    plans = response.json().get("value", [])
    for plan in plans:
        plan_id = plan["id"]
        if plan_id not in exclude_ids:
            delete_url = f"https://dev.azure.com/{organization}/{project}/_apis/test/plans/{plan_id}?api-version=7.1-preview.2"
            del_response = requests.delete(delete_url, headers=headers, auth=auth)
            if del_response.status_code == 200:
                print(f"Deleted Test Plan ID: {plan_id}")
            else:
                print(f"Failed to delete Test Plan ID: {plan_id} - {del_response.status_code}")
else:
    print(f"Failed to retrieve test plans: {response.status_code}")
