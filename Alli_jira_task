import requests
import pandas as pd
import time

# ---- CONFIGURATION ----
workspace_url = "https://<your-instance>.databricks.com"
access_token = "<your_personal_access_token>"

headers = {
    "Authorization": f"Bearer {access_token}"
}

# ---- INPUT: list of 'catalog.schema.table.column' or 'schema.table.column' ----
input_list = [
    "main_catalog.sales.orders.order_id",
    "main_catalog.finance.payments.payment_date",
    # add more...
]

# ---- PARSE FUNCTION ----
def parse_entry(entry):
    parts = entry.split('.')
    if len(parts) == 4:
        catalog, schema, table, column = parts
    elif len(parts) == 3:
        catalog = "main_catalog"  # fallback default
        schema, table, column = parts
    else:
        raise ValueError(f"Invalid format: {entry}")
    return catalog, schema, table, column

# ---- GET LINEAGE FUNCTION ----
def get_column_lineage(catalog, schema, table, column):
    dataset_name = f"{catalog}.{schema}.{table}"
    lineage_url = f"{workspace_url}/api/2.0/unity-catalog/lineage-tracking/lineage"

    params = {
        "dataset_name": dataset_name,
        "include_column_lineage": "true",
        "direction": "downstream",
        "depth": "3"
    }

    response = requests.get(lineage_url, headers=headers, params=params)
    if response.status_code != 200:
        print(f"Failed for {dataset_name}.{column}: {response.text}")
        return []

    data = response.json()
    downstream_refs = []

    for edge in data.get("column_lineage", []):
        if edge.get("source_column") == f"{dataset_name}.{column}":
            downstream_refs.append(edge.get("target_column"))

    return downstream_refs

# ---- MAIN PROCESSING ----
results = []

for entry in input_list:
    try:
        catalog, schema, table, column = parse_entry(entry)
        downstream = get_column_lineage(catalog, schema, table, column)
        results.append({
            "input": entry,
            "referenced_in": downstream
        })
        time.sleep(1)
    except Exception as e:
        results.append({
            "input": entry,
            "referenced_in": [],
            "error": str(e)
        })

# ---- OUTPUT TO CSV ----
df = pd.DataFrame(results)
df.to_csv("column_lineage_results.csv", index=False)
print("âœ… Lineage check completed. See 'column_lineage_results.csv'")
