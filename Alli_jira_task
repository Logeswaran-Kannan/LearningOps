DO
$$
DECLARE
    i INT;
    tbl_name TEXT;
    row_count BIGINT;
    has_createtime BOOLEAN;
    start_ts TIMESTAMP := '2025-05-12 00:00:01';
    end_ts TIMESTAMP := '2025-05-13 00:00:01';
    export_path TEXT := 'C:/Users/adm.logeswaran.kanna/Desktop/Export/PC/'; -- CHANGE THIS TO YOUR PATH
    sql TEXT;
    copy_cmd TEXT;
    input_tables TEXT[] := ARRAY['table1', 'table2']; -- ADD YOUR TABLE NAMES HERE
BEGIN
    FOR i IN 1 .. array_length(input_tables, 1) LOOP
        tbl_name := input_tables[i];

        -- Check if 'createtime' column exists
        SELECT EXISTS (
            SELECT 1
            FROM information_schema.columns
            WHERE table_schema = 'public'
              AND table_name = tbl_name
              AND column_name = 'createtime'
        ) INTO has_createtime;

        IF has_createtime THEN
            sql := format(
                'SELECT count(*) FROM public.%I WHERE createtime >= %L AND createtime < %L',
                tbl_name, start_ts, end_ts
            );
            EXECUTE sql INTO row_count;
            RAISE NOTICE 'Table: %, Filtered Count (createtime exists): %', tbl_name, row_count;

            IF row_count > 5000 THEN
                copy_cmd := format(
                    '\copy (SELECT * FROM public.%I WHERE createtime >= ''%s'' AND createtime < ''%s'') TO ''%s%s_filtered.csv'' WITH CSV HEADER',
                    tbl_name, start_ts, end_ts,
                    export_path, tbl_name
                );
            ELSE
                copy_cmd := format(
                    '\copy public.%I TO ''%s%s_full.csv'' WITH CSV HEADER',
                    tbl_name,
                    export_path, tbl_name
                );
            END IF;
        ELSE
            sql := format('SELECT count(*) FROM public.%I', tbl_name);
            EXECUTE sql INTO row_count;
            RAISE NOTICE 'Table: %, Full Count (no createtime): %', tbl_name, row_count;

            copy_cmd := format(
                '\copy public.%I TO ''%s%s_full.csv'' WITH CSV HEADER',
                tbl_name,
                export_path, tbl_name
            );
        END IF;

        -- Instead of executing, show the COPY command for manual execution
        RAISE NOTICE 'COPY command: %', copy_cmd;
    END LOOP;
END;
$$;
