# Initialize file counter
files_transferred = 0

# Loop through target directories
for directory_name in load_from_directories:

    # Get list of files in directory
    parent_dir = ShareDirectoryClient.from_connection_string(
        conn_str=file_share_connection_string,
        share_name=file_share_connection_name,
        directory_path=directory_name
    )

    directory = list(parent_dir.list_directories_and_files())

    # Loop through files and copy to corresponding volume
    for file_or_directory in directory:
        try:
            # Get file
            file_client = ShareFileClient.from_connection_string(
                conn_str=file_share_connection_string,
                share_name=file_share_connection_name,
                file_path=f"{directory_name}/{file_or_directory.name}"
            )

            # Write file to volume
            with open(f"/Volumes/{catalog_name}/{schema_name}/{directory_name}/{file_or_directory.name}", 'wb') as file_handle:
                data = file_client.download_file()
                data.readinto(file_handle)

            # Increment success counter
            files_transferred += 1

        except Exception as e:
            logger.error(f"Error occurred loading file: {file_or_directory.name} - {e}")

# Summary log
logger.info(f"Total files successfully transferred from file share to volume: {files_transferred}")
