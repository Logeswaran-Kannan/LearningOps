import requests
import pandas as pd

# Token and URL Setup
token = "test"
url = "https://adb-67779643136828772.12.azuredatabricks.net/api/2.0/lineage-tracking/column-lineage"
headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

# Parameters Setup
params = {
    "table_name": "core_tst_std001.ods_views.vw_policycenter_std001_current_pc_policy",
    "column_name": "productcode",
    "include_entity_lineage": True
}

# Request Execution
response = requests.get(url, headers=headers, params=params)

# Response Handling
if response.status_code == 200:
    data = response.json()

    # Flatten the JSON if needed
    upstream = pd.json_normalize(data.get('upstream_cols', []))
    downstream = pd.json_normalize(data.get('downstream_cols', []))

    print("\nUpstream Columns:\n")
    display(upstream)

    print("\nDownstream Columns:\n")
    display(downstream)

    # Optionally merge all into a single DataFrame with labels
    upstream["direction"] = "upstream"
    downstream["direction"] = "downstream"
    lineage_df = pd.concat([upstream, downstream], ignore_index=True)
    display(lineage_df)

else:
    print(f"Request failed with status code {response.status_code}")
    print(response.text)
