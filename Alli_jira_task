CREATE OR REPLACE FUNCTION get_counts_on_date(target_date DATE)
RETURNS TABLE(table_name TEXT, row_count BIGINT)
LANGUAGE plpgsql
AS
$$
DECLARE
    tbl RECORD;
    sql TEXT;
BEGIN
    FOR tbl IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'public'
    LOOP
        IF EXISTS (
            SELECT 1
            FROM information_schema.columns
            WHERE table_schema = 'public'
              AND table_name = tbl.tablename
              AND column_name = 'updatetime'
        ) THEN
            -- Table has updatetime, filter by date
            sql := format(
                'SELECT %L::TEXT, count(*) FROM public.%I WHERE updatetime::date = %L',
                tbl.tablename, tbl.tablename, target_date
            );
            RETURN QUERY EXECUTE sql;
        ELSE
            -- Table has no updatetime column, return 0
            RETURN QUERY
            SELECT tbl.tablename, 0;
        END IF;
    END LOOP;
END;
$$;
