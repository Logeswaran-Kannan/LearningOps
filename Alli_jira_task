-- Step 1: Aggregate count of loaded tables per domain, per run_id, per date
-- Assuming 'data loaded' means successful load in `comment`

WITH loaded_tables AS (
  SELECT
    run_id,
    domain,
    DATE(timestamp) AS load_date,
    COUNT(*) AS tables_loaded
  FROM core_tst_sys9.default.audit_table_count_check
  WHERE LOWER(comment) = 'data loaded'
  GROUP BY run_id, domain, DATE(timestamp)
),

-- Step 2: Total tables checked per domain per run_id per day
all_tables AS (
  SELECT
    run_id,
    domain,
    DATE(timestamp) AS load_date,
    COUNT(*) AS total_tables
  FROM core_tst_sys9.default.audit_table_count_check
  GROUP BY run_id, domain, DATE(timestamp)
),

-- Step 3: Combine and calculate not loaded count
load_summary AS (
  SELECT
    a.run_id,
    a.domain,
    a.load_date,
    COALESCE(l.tables_loaded, 0) AS tables_loaded,
    a.total_tables,
    a.total_tables - COALESCE(l.tables_loaded, 0) AS not_loaded
  FROM all_tables a
  LEFT JOIN loaded_tables l
    ON a.run_id = l.run_id AND a.domain = l.domain AND a.load_date = l.load_date
)

-- Step 4: Final alert generation with detailed load status
SELECT
  run_id,
  domain,
  load_date,
  tables_loaded,
  total_tables,
  not_loaded,
  CASE 
    WHEN not_loaded >= 100 THEN CONCAT('ALERT: Only ', tables_loaded, ' of ', total_tables, ' tables loaded')
    ELSE CONCAT('OK: ', tables_loaded, ' of ', total_tables, ' tables loaded')
  END AS load_status
FROM load_summary
ORDER BY load_date DESC, run_id, domain;
