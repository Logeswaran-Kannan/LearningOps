# Databricks script with fixed column access and bar charts for Teams notification

import requests
import json
from datetime import datetime
from pyspark.sql.functions import col, count, max as spark_max

webhook_url = "<Your-Teams-Webhook-URL>"

# 1. Data Load Status
latest_run_id = spark.sql("SELECT MAX(run_id) AS latest_run_id FROM core_tst_sys9.default.audit_table_count_check")
latest_run_id = latest_run_id.collect()[0]["latest_run_id"]

data_status_df = spark.sql(f"""
    SELECT domain,
           COUNT(*) AS total_tables,
           SUM(CASE WHEN ods_stg_copy_count > 0 THEN 1 ELSE 0 END) AS stg_loaded,
           SUM(CASE WHEN ods_count > 0 THEN 1 ELSE 0 END) AS ods_loaded,
           SUM(CASE WHEN ods_views_count > 0 THEN 1 ELSE 0 END) AS view_loaded
    FROM core_tst_sys9.default.audit_table_count_check
    WHERE run_id = '{latest_run_id}'
    GROUP BY domain
""")

# 2. Schema Deviation Result
latest_ts = spark.sql("SELECT MAX(load_timestamp) AS latest_ts FROM core_tst_sys9.default.ddl_comparison_results").collect()[0]["latest_ts"]

schema_deviation_df = spark.sql(f"""
    SELECT status, COUNT(DISTINCT targettablename) AS count
    FROM core_tst_sys9.default.ddl_comparison_results
    WHERE load_timestamp = '{latest_ts}'
    GROUP BY status
""")

# 3. ODS Data Validation
ods_run_id = spark.sql("SELECT MAX(run_id) AS latest_run_id FROM core_tst_sys9.default.result_table").collect()[0]["latest_run_id"]

ods_validation_df = spark.sql(f"""
    SELECT processed_comment, COUNT(*) AS count
    FROM (
        SELECT *, 
               CASE WHEN comment LIKE 'Error: [TABLE_OR_VIEW_NOT_FOUND]%' THEN 'TABLE_OR_VIEW_NOT_FOUND'
                    ELSE comment END AS processed_comment
        FROM core_tst_sys9.default.result_table
        WHERE run_id = '{ods_run_id}'
    )
    GROUP BY processed_comment
""")

# 4. ODS_VIEW Data Validation
ods_view_run_id = spark.sql("SELECT MAX(run_id) AS latest_run_id FROM core_tst_sys9.default.result_view_table").collect()[0]["latest_run_id"]

ods_view_validation_df = spark.sql(f"""
    SELECT processed_comment, COUNT(*) AS count
    FROM (
        SELECT *, 
               CASE WHEN comment LIKE 'Error: [TABLE_OR_VIEW_NOT_FOUND]%' THEN 'TABLE_OR_VIEW_NOT_FOUND'
                    ELSE comment END AS processed_comment
        FROM core_tst_sys9.default.result_view_table
        WHERE run_id = '{ods_view_run_id}'
    )
    GROUP BY processed_comment
""")

# Create bar chart row as HTML segments

def bar_chart_row(label, total, segments):
    html = f"<p><strong>{label}</strong></p><div style='display:flex;width:100%;height:20px;border:1px solid #ccc;'>"
    for seg in segments:
        color, value = seg
        width = (value / total * 100) if total else 0
        html += f"<div style='width:{width}%;background:{color};'></div>"
    html += "</div><br/>"
    return html

html = "<h2>ðŸ“Š ETL Health Dashboard</h2>"

# Data Load Section
html += "<h3>Data Load Status</h3>"
for row in data_status_df.collect():
    total = row['total_tables']
    segments = [
        ("#4CAF50", row['stg_loaded']),
        ("#2196F3", row['ods_loaded']),
        ("#FFC107", row['view_loaded'])
    ]
    html += bar_chart_row(row['domain'], total, segments)

# Schema Deviation Section
html += "<h3>Schema Deviation</h3>"
schema_rows = schema_deviation_df.collect()
schema_total = sum([r['count'] for r in schema_rows])
schema_segments = []
for r in schema_rows:
    color = "#4CAF50" if r['status'] == 'All Pass' else "#F44336"
    schema_segments.append((color, r['count']))
html += bar_chart_row("Schema Deviation", schema_total, schema_segments)

# ODS Validation Section
html += "<h3>ODS Validation</h3>"
ods_rows = ods_validation_df.collect()
ods_total = sum([r['count'] for r in ods_rows])
ods_segments = []
for r in ods_rows:
    color = "#4CAF50" if 'passed' in r['processed_comment'].lower() else "#F44336"
    ods_segments.append((color, r['count']))
html += bar_chart_row("ODS Checks", ods_total, ods_segments)

# ODS View Validation Section
html += "<h3>ODS_VIEW Validation</h3>"
ods_view_rows = ods_view_validation_df.collect()
ods_view_total = sum([r['count'] for r in ods_view_rows])
ods_view_segments = []
for r in ods_view_rows:
    color = "#4CAF50" if 'passed' in r['processed_comment'].lower() else "#F44336"
    ods_view_segments.append((color, r['count']))
html += bar_chart_row("ODS_VIEW Checks", ods_view_total, ods_view_segments)

# MessageCard for Teams
card = {
    "@type": "MessageCard",
    "@context": "http://schema.org/extensions",
    "summary": "ETL Health Report",
    "themeColor": "0076D7",
    "title": "ðŸ“¥ ETL Health Status - {}".format(datetime.now().strftime("%Y-%m-%d %H:%M:%S")),
    "text": html
}

# Send to Teams
response = requests.post(webhook_url, headers={"Content-Type": "application/json"}, data=json.dumps(card))

if response.status_code != 200:
    raise ValueError(f"Request to Teams returned error {response.status_code}, the response is:\n{response.text}")
else:
    print("Notification sent successfully!")
