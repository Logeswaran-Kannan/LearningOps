-- Step 1: Define schema for the expected JSON structure
-- (You can adjust field types if needed)

WITH source_data AS (
  SELECT 
    CAST(Payload AS STRING) AS Payload_str
  FROM mqs.dlt_quote_request
  WHERE Payload IS NOT NULL
),

-- Step 2: Parse the JSON using a defined schema
parsed AS (
  SELECT 
    from_json(Payload_str, '
    STRUCT<
      coreRisk: STRUCT<
        drivers: ARRAY<STRUCT<
          incidents: STRUCT<
            claims: ARRAY<STRUCT<
              claim_PRN: STRING,
              claim_ClaimType: STRING,
              claim_Date: STRING,
              claim_DriverAtFaultInd: STRING,
              claim_NcdLostInd: STRING
            >>
          >
        >>
      >
    >') AS parsed_json
  FROM source_data
),

-- Step 3: Flatten the nested structure
exploded AS (
  SELECT 
    EXPLODE(parsed_json.coreRisk.drivers) AS driver
  FROM parsed
),

claims AS (
  SELECT 
    EXPLODE(driver.incidents.claims) AS claim
  FROM exploded
)

-- Step 4: Select the required fields
SELECT
  claim.claim_PRN,
  claim.claim_ClaimType,
  claim.claim_Date,
  claim.claim_DriverAtFaultInd,
  claim.claim_NcdLostInd
FROM claims;
