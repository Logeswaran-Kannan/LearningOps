WITH source_data AS (
  SELECT 
    CAST(Payload AS STRING) AS Payload_str
  FROM mqs.dlt_quote_request
  WHERE Payload IS NOT NULL
),

parsed AS (
  SELECT 
    from_json(Payload_str, '
    STRUCT<
      coreRisk: ARRAY<STRUCT<
        drivers: ARRAY<STRUCT<
          incidents: STRUCT<
            claims: ARRAY<STRUCT<
              claim_ClaimType: STRING,
              claim_Date: STRING,
              claim_DriverAtFaultInd: STRING,
              claim_NcdLostInd: STRING,
              claim_Prn: INT
            >>
          >
        >>
      >>
    >') AS parsed_json
  FROM source_data
),

core_risk_exploded AS (
  SELECT explode(parsed_json.coreRisk) AS core_risk FROM parsed
),

drivers_exploded AS (
  SELECT explode(core_risk.drivers) AS driver FROM core_risk_exploded
),

claims_exploded AS (
  SELECT explode(driver.incidents.claims) AS claim FROM drivers_exploded
)

-- Final selection of required fields
SELECT
  claim.claim_ClaimType,
  claim.claim_Date,
  claim.claim_DriverAtFaultInd,
  claim.claim_NcdLostInd,
  claim.claim_Prn
FROM claims_exploded;
