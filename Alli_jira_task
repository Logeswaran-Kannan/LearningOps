DO
$$
DECLARE
    tbl RECORD;
    filtered_count BIGINT;
    has_column BOOLEAN;
    start_time TIMESTAMP := '2025-05-12 00:00:01+00';
    end_time   TIMESTAMP := '2025-05-13 00:00:01+00';
BEGIN
    FOR tbl IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'public'
    LOOP
        -- Check if 'updatetime' column exists
        SELECT EXISTS (
            SELECT 1
            FROM information_schema.columns
            WHERE table_schema = 'public'
              AND table_name = tbl.tablename
              AND column_name = 'updatetime'
        ) INTO has_column;

        IF has_column THEN
            -- Count rows within the specified time range
            EXECUTE format(
                'SELECT count(*) FROM public.%I WHERE updatetime BETWEEN TIMESTAMP %L AND TIMESTAMP %L',
                tbl.tablename, start_time, end_time
            ) INTO filtered_count;

            RAISE NOTICE 'Table: %, Rows between % and %: %',
                tbl.tablename, start_time, end_time, filtered_count;
        ELSE
            RAISE NOTICE 'Table: % skipped - no updatetime column', tbl.tablename;
        END IF;
    END LOOP;
END;
$$;
