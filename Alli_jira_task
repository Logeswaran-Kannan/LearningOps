DO
$$
DECLARE
    tbl RECORD;
    row_count BIGINT;
    has_updatetime BOOLEAN;
    start_ts TIMESTAMP := '2025-05-12 00:00:01';
    end_ts TIMESTAMP := '2025-05-13 00:00:01';
    export_query TEXT;
    output_path TEXT := '/your/export/path/'; -- Change this to your target path
    input_tables TEXT[] := ARRAY['table1', 'table2', 'table3']; -- Replace with your table names
BEGIN
    FOR tbl IN
        SELECT unnest(input_tables) AS tablename
    LOOP
        -- Check if 'updatetime' column exists
        SELECT EXISTS (
            SELECT 1
            FROM information_schema.columns
            WHERE table_schema = 'public'
              AND table_name = tbl.tablename
              AND column_name = 'updatetime'
        ) INTO has_updatetime;

        -- Update 'updatetime' as 'createtime' if applicable
        IF has_updatetime THEN
            EXECUTE format(
                'UPDATE public.%I SET updatetime = createtime WHERE updatetime IS DISTINCT FROM createtime',
                tbl.tablename
            );
        END IF;

        -- Determine row count
        IF has_updatetime THEN
            EXECUTE format(
                'SELECT count(*) FROM public.%I WHERE updatetime >= %L AND updatetime < %L',
                tbl.tablename, start_ts, end_ts
            ) INTO row_count;
        ELSE
            EXECUTE format('SELECT count(*) FROM public.%I', tbl.tablename) INTO row_count;
        END IF;

        -- Construct export query
        IF row_count <= 5000 THEN
            export_query := format(
                'COPY (SELECT * FROM public.%I) TO %L WITH CSV HEADER',
                tbl.tablename, output_path || tbl.tablename || '.csv'
            );
        ELSE
            export_query := format(
                'COPY (SELECT * FROM public.%I WHERE updatetime >= %L AND updatetime < %L) TO %L WITH CSV HEADER',
                tbl.tablename, start_ts, end_ts, output_path || tbl.tablename || '.csv'
            );
        END IF;

        -- Execute export
        EXECUTE export_query;

        RAISE NOTICE 'Exported table % with % rows', tbl.tablename, row_count;
    END LOOP;
END;
$$;
