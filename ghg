import requests
import pandas as pd
from tkinter import filedialog, Tk

# Jira API base URL
jira_url = "https://your-jira-instance.atlassian.net/rest/api/latest/issue/"

# Jira token (Replace with your Jira API token)
jira_token = "your-jira-token"

# Function to link defect IDs with existing test cases in Jira
def link_defect_to_test_case(defect_id, test_case_id):
    headers = {
        "Authorization": f"Basic {jira_token}",
        "Content-Type": "application/json",
    }

    data = {
        "update": {
            "issuelinks": [
                {
                    "add": {
                        "type": {"name": "Tests"},
                        "inwardIssue": {"key": defect_id},
                        "outwardIssue": {"key": test_case_id},
                    }
                }
            ]
        }
    }

    response = requests.post(jira_url + test_case_id, json=data, headers=headers)
    if response.status_code == 204:
        print(f"Defect {defect_id} linked with Test Case {test_case_id} successfully.")
    else:
        print(f"Error linking defect {defect_id} with Test Case {test_case_id}.")
        print(response.json())


# GUI to get Excel file path
def get_excel_file_path():
    root = Tk()
    root.withdraw()
    file_path = filedialog.askopenfilename(title="Select Excel File", filetypes=[("Excel Files", "*.xlsx")])
    return file_path


# Main function to link defects with test cases
def main():
    # Get Excel file path using GUI
    excel_file_path = get_excel_file_path()

    # Read the data from Excel file
    df = pd.read_excel(excel_file_path)

    # Iterate through each row and link defects with test cases
    for index, row in df.iterrows():
        defect_id = row["Defect ID"]
        test_case_id = row["Test Case ID"]
        link_defect_to_test_case(defect_id, test_case_id)


if __name__ == "__main__":
    main()
