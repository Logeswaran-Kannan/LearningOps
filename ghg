import os
import tkinter as tk
from tkinter import filedialog
from jira import JIRA
import openpyxl

def connect_to_jira(server, username, jira_token):
    try:
        options = {
            'server': server,
            'basic_auth': (username, jira_token)
        }
        jira = JIRA(options)
        return jira
    except Exception as e:
        print("Failed to connect to Jira. Error:", e)
        return None

def link_defects_to_bugs(jira, excel_file_path):
    try:
        wb = openpyxl.load_workbook(excel_file_path)
        ws = wb.active
        for row in ws.iter_rows(min_row=2, values_only=True):
            defect_id, bug_id = row[0], row[1]
            jira.add_issues_to_epic(bug_id, [defect_id])
        print("Defect IDs linked to bugs successfully!")
        return True
    except Exception as e:
        print("Failed to link defects to bugs. Error:", e)
        return False

def ask_file_path():
    root = tk.Tk()
    root.withdraw()
    file_path = filedialog.askopenfilename(filetypes=[("Excel Files", "*.xlsx")])
    return file_path

if __name__ == "__main__":
    server = input("Jira Server URL: ")
    username = input("Jira Username: ")
    jira_token = input("Jira Token (API token or password): ")

    jira = connect_to_jira(server, username, jira_token)

    if jira:
        print("Successfully connected to Jira.")
        excel_file_path = ask_file_path()
        if excel_file_path:
            connection_success = link_defects_to_bugs(jira, excel_file_path)
            if connection_success:
                print("Defect IDs linked to bugs successfully!")
            else:
                print("Failed to link defects to bugs.")
        else:
            print("No Excel file selected.")
    else:
        print("Connection to Jira failed. Please check your credentials and Jira server URL.")
