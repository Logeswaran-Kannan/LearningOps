import openpyxl
import requests
import tkinter as tk
from tkinter import filedialog

# Jira credentials and URL
JIRA_BASE_URL = "https://your-jira-instance.atlassian.net"
JIRA_USERNAME = "your-jira-username"
JIRA_TOKEN = "your-jira-token"

# Function to authenticate with Jira API using token
def jira_auth():
    return requests.auth.HTTPBasicAuth(JIRA_USERNAME, JIRA_TOKEN)

# Function to link defect ID with an existing test case in Jira
def link_defect_with_test_case(defect_id, test_case_key):
    url = f"{JIRA_BASE_URL}/rest/api/2/issueLink"
    auth = jira_auth()
    headers = {"Content-Type": "application/json"}

    data = {
        "type": {
            "name": "Tests"
        },
        "inwardIssue": {
            "key": test_case_key
        },
        "outwardIssue": {
            "key": defect_id
        }
    }

    response = requests.post(url, json=data, auth=auth, headers=headers)
    if response.status_code == 201:
        print(f"Successfully linked Defect {defect_id} with Test Case {test_case_key}")
    else:
        print(f"Failed to link Defect {defect_id} with Test Case {test_case_key}")

# Function to open file dialog and get the Excel file path
def get_excel_file_path():
    root = tk.Tk()
    root.withdraw()
    file_path = filedialog.askopenfilename(title="Select Excel File", filetypes=[("Excel files", "*.xlsx")])
    return file_path

# Main function
def main():
    excel_file_path = get_excel_file_path()

    if excel_file_path:
        workbook = openpyxl.load_workbook(excel_file_path)
        worksheet = workbook.active

        for row in worksheet.iter_rows(min_row=2, values_only=True):
            defect_id, test_case_key = row[0], row[1]
            link_defect_with_test_case(defect_id, test_case_key)

if __name__ == "__main__":
    main()
