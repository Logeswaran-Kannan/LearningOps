from pyspark.sql import SparkSession
from pyspark.sql.functions import col, lit

# Initialize SparkSession
spark = SparkSession.builder.appName("DataComparison").getOrCreate()

# Replace these with your actual file paths and table names
csv_file_path = "/dbfs/path/to/your/csv_file.csv"
database_name = "your_database"
first_table_name = "table_from_csv"
second_table_name = "existing_table"
output_table_name = "data_comparison_output"
columns_to_compare = ["column1", "column2", "column3"]  # Add the columns you want to compare

# Create the first table from the CSV file, if it doesn't exist
try:
    spark.sql(f"CREATE DATABASE IF NOT EXISTS {database_name}")
    df_csv = spark.read.option("header", "true").csv(csv_file_path)
    df_csv.write.mode("overwrite").saveAsTable(f"{database_name}.{first_table_name}")
except Exception as e:
    print(f"Error creating first table: {e}")

# Query both tables using the policy_reference as the filter
try:
    df_first_table = spark.sql(f"SELECT * FROM {database_name}.{first_table_name}")
    df_second_table = spark.sql(f"SELECT * FROM {database_name}.{second_table_name}")
except Exception as e:
    print(f"Error querying tables: {e}")

# Perform the column-wise minus for the specified columns
diff_df = df_first_table.select("policy_reference", *columns_to_compare).subtract(
    df_second_table.select("policy_reference", *columns_to_compare)
)

# Prepare the output DataFrame with differences and status
output_df = diff_df.select("policy_reference", *columns_to_compare).withColumn("status", lit("Fail"))

# If there are no differences, mark the status as "Pass"
if output_df.count() == 0:
    output_df = df_first_table.select("policy_reference", *columns_to_compare).withColumn("status", lit("Pass"))

# Create the output table to capture the differences
try:
    output_df.write.mode("overwrite").saveAsTable(f"{database_name}.{output_table_name}")
except Exception as e:
    print(f"Error creating output table: {e}")

# Show the results
output_df.show()

# Stop the SparkSession
spark.stop()
