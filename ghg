import os
import tkinter as tk
from tkinter import filedialog
from jira import JIRA
from openpyxl import load_workbook

def connect_to_jira(server, username, token):
    try:
        jira = JIRA(server, basic_auth=(username, token))
        return jira, True
    except Exception as e:
        return None, False

def update_ticket(jira, ticket_key, linked_issue_key):
    issue = jira.issue(ticket_key)
    issue.fields.issuelinks.append({"outwardIssue": {"key": linked_issue_key}})
    issue.update()

def ask_excel_file():
    root = tk.Tk()
    root.withdraw()
    file_path = filedialog.askopenfilename(title="Select Excel File")
    return file_path

def main():
    # Ask for Jira server details
    jira_server = input("Enter Jira server URL: ")
    jira_username = input("Enter Jira username: ")
    jira_token = input("Enter Jira token: ")

    # Connect to Jira
    jira, is_connected = connect_to_jira(jira_server, jira_username, jira_token)
    if not is_connected:
        print("Failed to connect to Jira.")
        return

    # Ask for Excel file
    excel_file_path = ask_excel_file()
    if not excel_file_path:
        print("No Excel file selected.")
        return

    # Read data from Excel and update Jira tickets
    workbook = load_workbook(excel_file_path)
    worksheet = workbook.active

    for row in worksheet.iter_rows(min_row=2, values_only=True):
        ticket_key, linked_issue_key = row[0], row[1]
        update_ticket(jira, ticket_key, linked_issue_key)
        print(f"Linked issue '{linked_issue_key}' to ticket '{ticket_key}'")

    print("All tickets updated successfully.")

if __name__ == "__main__":
    main()
