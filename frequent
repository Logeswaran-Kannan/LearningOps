# Step 1: Import the required libraries
from pyspark.sql import SparkSession
from pyspark.sql.functions import col

# Step 2: Create a SparkSession
spark = SparkSession.builder \
    .appName("DataTesting") \
    .getOrCreate()

# Step 3: Define the paths for CSV files and table names
csv_path = "/dbfs/path/to/csv_file.csv"
table_name = "created_table"
existing_table_name = "existing_table"

# Step 4: Load the CSV file and create a table with overwrite option
created_table_df = spark.read.csv(csv_path, header=True, inferSchema=True)
created_table_df.write.mode("overwrite").saveAsTable(table_name)

# Step 5: Query the existing table based on the policy numbers mentioned in the sheet
existing_table_df = spark.sql(f"SELECT * FROM {existing_table_name} WHERE policy_number IN (SELECT DISTINCT policy_number FROM {table_name})")

# Step 6: Perform column-wise minus between the created table and existing table
diff_df = created_table_df.join(existing_table_df, on="policy_number", how="left_anti")

# Step 7: Capture the before and after pictures of the differences
before_pandas_df = existing_table_df.toPandas()
after_pandas_df = diff_df.toPandas()

# Step 8: Highlight the differences for each policy number column-wise
for column in created_table_df.columns:
    diff_pandas_df = after_pandas_df[after_pandas_df[column].ne(before_pandas_df[column])]
    print(f"Differences for column '{column}':")
    print(diff_pandas_df)

# Step 9: Stop the SparkSession
spark.stop()
