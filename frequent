# Read the CSV file from DBFS
csv_file_path = "/dbfs/path/to/csv/file.csv"
df = spark.read.format("csv").option("header", "true").load(csv_file_path)

# Register the DataFrame as a temporary view
df.createOrReplaceTempView("temp_table")

table_name = "existing_table"

# Check if the table exists
if spark.catalog.tableExists(table_name):
    # If the table exists, drop it to overwrite
    spark.sql(f"DROP TABLE IF EXISTS {table_name}")

# Create a new table using the DataFrame
spark.sql(f"CREATE TABLE {table_name} AS SELECT * FROM temp_table")

# Query the existing table using SQL
existing_table_name = "existing_table"
query_result = spark.sql(f"SELECT * FROM {existing_table_name}")

# Perform the minus operation for each column based on the policy number
policy_column = "policy_number"
columns_to_compare = df.columns

for column in columns_to_compare:
    minus_df = df.select(policy_column, column).subtract(query_result.select(policy_column, column))
    minus_df.createOrReplaceTempView(f"minus_table_{column}")

# Highlight differences for each column based on the policy number
highlighted_differences_df = df

for column in columns_to_compare:
    minus_table_name = f"minus_table_{column}"
    join_condition = f"{highlighted_differences_df[policy_column]} = {minus_table_name}[{policy_column}]"
    
    highlighted_differences_df = highlighted_differences_df \
        .join(minus_table_name, join_condition, "left_outer") \
        .withColumn(f"diff_{column}", when(col(f"{column}_x").isNull(), col(f"{column}_y")).otherwise(col(column))) \
        .drop(f"{column}_x", f"{column}_y")

# Show the highlighted differences
highlighted_differences_df.show()
