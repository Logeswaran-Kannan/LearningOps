# Import necessary libraries
from pyspark.sql import SparkSession
from pyspark.sql.functions import *
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from IPython.display import HTML

# Initialize Spark session
spark = SparkSession.builder.appName("ExploratoryDataAnalysis").getOrCreate()

# Load data from DLT view
data = spark.sql("SELECT * FROM your_dlt_view")

# Display basic statistics
summary = data.describe().toPandas()

# Display missing values count
missing_values = data.select([count(when(col(c).isNull(), c)).alias(c) for c in data.columns]).toPandas()

# Create correlation matrix
correlation_matrix = data.drop("some_non-numeric_columns").toPandas().corr()

# Visualize distributions using Seaborn
sns.set(style="whitegrid")
plt.figure(figsize=(12, 8))
for column in data.columns:
    sns.histplot(data.toPandas(), x=column, kde=True)
    plt.title(f'Distribution of {column}')
    plt.show()

# Convert summary, missing_values, and correlation_matrix to HTML
summary_html = summary.to_html()
missing_values_html = missing_values.to_html()
correlation_matrix_html = correlation_matrix.style.background_gradient(cmap='coolwarm').render()

# Combine HTML components
eda_report_html = f"""
<html>
<head>
<style>
{correlation_matrix_html}
</style>
</head>
<body>
<h2>Exploratory Data Analysis Report</h2>
<h3>Summary Statistics</h3>
{summary_html}
<h3>Missing Values</h3>
{missing_values_html}
<h3>Correlation Matrix</h3>
{correlation_matrix_html}
</body>
</html>
"""

# Display the EDA report in the notebook
displayHTML(eda_report_html)
