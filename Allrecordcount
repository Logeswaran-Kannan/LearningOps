-- Extract the latest run_id
WITH latest_run AS (
    SELECT MAX(run_id) AS run_id
    FROM core_tst_sys9.default.data_migration_validation_results
)

-- Generate KPIs based on the latest run
SELECT 
    run_id,
    table_name,
    src_database,
    tgt_database,
    COUNT(*) AS total_tests,
    SUM(CASE WHEN status = 'Success' THEN 1 ELSE 0 END) AS success_count,
    SUM(CASE WHEN status = 'Failure' THEN 1 ELSE 0 END) AS failure_count,
    SUM(CASE WHEN src_vs_tgt_missing_columns IS NOT NULL THEN 1 ELSE 0 END) AS src_vs_tgt_missing_col_count,
    SUM(CASE WHEN tgt_vs_src_missing_columns IS NOT NULL THEN 1 ELSE 0 END) AS tgt_vs_src_missing_col_count,
    SUM(src_count) AS total_src_records,
    SUM(tgt_count) AS total_tgt_records,
    SUM(src_duplicate_count) AS total_src_duplicates,
    SUM(tgt_duplicate_count) AS total_tgt_duplicates,
    SUM(src_vs_tgt_data_mismatch_count) AS total_src_vs_tgt_mismatches,
    SUM(tgt_vs_src_data_mismatch_count) AS total_tgt_vs_src_mismatches,
    SUM(CASE WHEN null_diff_columns IS NOT NULL THEN 1 ELSE 0 END) AS null_diff_column_issues,
    SUM(CASE WHEN data_mismatch_columns IS NOT NULL THEN 1 ELSE 0 END) AS data_mismatch_column_issues,
    AVG(time_taken_seconds) AS avg_time_taken_seconds,
    MAX(time_taken_seconds) AS max_time_taken_seconds,
    MIN(time_taken_seconds) AS min_time_taken_seconds
FROM core_tst_sys9.default.data_migration_validation_results
JOIN latest_run ON data_migration_validation_results.run_id = latest_run.run_id
GROUP BY run_id, table_name, src_database, tgt_database
ORDER BY run_id DESC;
