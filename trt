from pyspark.sql import SparkSession
from pyspark.sql.functions import col

# Initialize Spark session
spark = SparkSession.builder \
    .appName("TableComparison") \
    .getOrCreate()

# Set source and destination database names
source_db = "source_database"
destination_db = "destination_database"

# List tables in the source database
source_tables = spark.sql(f"SHOW TABLES IN {source_db}").select("tableName").collect()

# Iterate through the source tables and compare with destination
for table_row in source_tables:
    table_name = table_row["tableName"]

    # Exclude tables starting with '__apply' or '__ghg'
    if table_name.startswith("__apply") or table_name.startswith("__ghg"):
        continue

    try:
        # Get schema information for the source table
        source_schema = spark.sql(f"DESCRIBE {source_db}.{table_name}")
        
        # Get schema information for the destination table
        destination_schema = spark.sql(f"DESCRIBE {destination_db}.{table_name}")
        
        # Compare data, count, column names, and data types
        if source_schema.subtract(destination_schema).count() == 0:
            print(f"Table '{table_name}' is identical in both databases.")
        else:
            print(f"Table '{table_name}' is different between databases.")
    
    except Exception as e:
        print(f"Table '{table_name}' missing in destination database.")

# Stop the Spark session
spark.stop()
